#!/bin/busybox sh
# Copyright 2015 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.
#
# /init script for use in factory install shim.
# Note that this script uses the busybox shell (not bash, not dash).

#original: https://chromium.googlesource.com/chromiumos/platform/initramfs/+/refs/heads/main/factory_shim/init

# Enable debugging to see what's happening
set -x

detect_tty() {
  if [ -f "/bin/frecon-lite" ]; then
    export TTY1="/dev/pts/0"
    export TTY2="/dev/pts/1"
  else
    export TTY1="/dev/tty1"
    export TTY2="/dev/tty2"
  fi
}

setup_environment() {
  echo "SHIMBOOT: Setting up environment..." > /dev/console
  # Install additional utility programs.
  /bin/busybox --install /bin || true
  
  # Immediately prevent factory installer from running
  # Create marker files before anything else
  echo "SHIMBOOT: Creating factory installer disable markers..." > /dev/console
  mkdir -p /tmp /root
  touch /tmp/.factory_installer_disabled
  touch /root/.factory_test
  export FACTORY_OMAHA_URL=""
  export DISABLE_FACTORY_INSTALLER=1
  echo "SHIMBOOT: Environment setup complete" > /dev/console
}

main() {
  echo "SHIMBOOT: Init script starting..." > /dev/console
  setup_environment
  detect_tty
  
  # Skip directly to our bootstrap, bypassing all factory installer logic
  echo "SHIMBOOT: Bypassing factory installer, booting custom OS..." > /dev/console
  echo "SHIMBOOT: Bypassing factory installer, booting custom OS..." > "$TTY1"
  
  # Execute bootstrap directly
  echo "SHIMBOOT: Executing bootstrap.sh..." > /dev/console
  exec /bin/sh /bin/bootstrap.sh < "$TTY1" >> "$TTY1" 2>&1
}

echo "SHIMBOOT: /init called with args: $@" > /dev/console
main "$@"
exit 0